flowchart LR
    U["User"]
    I["Intent"]
    R["Reconciliation"]
    C["Command/Event Loop"]
    S["State Update"]

    subgraph M["Mirage (Orchestration Only)"]
        MG["local_ghost_id + locality preference policy"]
    end

    subgraph LG["Local Ghost (co-located with Mirage)"]
        LGR["raft-node seed (raft://local-ghost)"]
        LGM["mongodb seed (mongodb://local-ghost)"]
        LGD["kdht-node seed (dht://local-ghost)"]
    end

    subgraph RG1["Remote Ghost A"]
        RGA["raft-node seed (raft://ghost-a)"]
        RGM["mongodb seed (mongodb://ghost-a)"]
        RGD["kdht-node seed (dht://ghost-a)"]
    end

    subgraph RG2["Remote Ghost B"]
        RGB["raft-node seed (raft://ghost-b)"]
        RGBM["mongodb seed (mongodb://ghost-b)"]
        RGBD["kdht-node seed (dht://ghost-b)"]
    end

    U --> I
    I --> R
    R --> C
    C --> S
    S --> R
    MG -. "locality-aware target selection" .-> C

    C -->|"command(join/replicate raft-node)"| LGR
    C -->|"command(join/replicate raft-node)"| RGA
    C -->|"command(join/replicate raft-node)"| RGB
    C -->|"command(db-op, local preferred)"| LGM
    C -->|"command(db-op, remote by URI)"| RGM
    C -->|"command(db-op, remote by URI)"| RGBM
    C -->|"command(storage.move source_uri,target_uri)"| LGM
    C -->|"command(storage.move source_uri,target_uri)"| RGM
    C -->|"command(dht.join/dht.store/dht.find)"| LGD
    C -->|"command(dht.join/dht.store/dht.find)"| RGD
    C -->|"command(dht.join/dht.store/dht.find)"| RGBD

    LGR -->|"event(term/leader/commit)"| C
    RGA -->|"event(term/leader/commit)"| C
    RGB -->|"event(term/leader/commit)"| C
    LGM -->|"event(db/status/health)"| C
    RGM -->|"event(db/status/health)"| C
    RGBM -->|"event(db/status/health)"| C
    LGD -->|"event(dht/peer/route/replica)"| C
    RGD -->|"event(dht/peer/route/replica)"| C
    RGBD -->|"event(dht/peer/route/replica)"| C
