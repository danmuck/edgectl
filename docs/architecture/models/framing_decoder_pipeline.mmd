flowchart LR
    A["Read header bytes"] --> B{"magic/version valid?"}
    B -- "No" --> X["Reject frame and close session"]
    B -- "Yes" --> C{"payload_len <= max?"}
    C -- "No" --> X
    C -- "Yes" --> D["Read auth block if has_auth"]
    D --> E["Read payload bytes"]
    E --> F["Decode TLV fields"]
    F --> G{"Required fields by message_type?"}
    G -- "No" --> H["Reject message; emit protocol error"]
    G -- "Yes" --> I["Dispatch to semantic handler"]
